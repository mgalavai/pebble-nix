name: Build Pebble App

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out your repository code
      - uses: actions/checkout@v2

      # Step 2: Install Nix
      - uses: cachix/install-nix-action@v15
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      # Step 3: Install Cachix manually
      - name: Install Cachix
        run: nix-env -iA cachix -f https://cachix.org/api/v1/install

      # Step 4: Verify Cachix installation
      - name: Verify Cachix
        run: |
          echo "PATH is: $PATH"
          which cachix || echo "cachix not found"
          cachix --version || echo "cachix version check failed"

      # Step 5: Configure Cachix to use the pebble cache
      - name: Configure Cachix
        run: cachix use pebble

      # Step 6: Build the Pebble app
      - name: Build Pebble App
        run: nix-shell --run "pebble build"