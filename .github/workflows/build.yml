name: Build with Lix

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Nix - simpler and more direct approach
      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      # Install Lix using Nix directly
      - name: Install Lix
        run: |
          nix-env -iA nixpkgs.lix
          echo "Lix installation path:"
          which lix || echo "lix not found after installation"

      - name: Setup Nix environment and check version
        run: |
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          echo "PATH: $PATH"
          which lix || echo "lix not found"
          lix --version || echo "lix command failed"

      - name: List installed binaries
        run: |
          echo "Contents of /nix/var/nix/profiles/default/bin:"
          ls -l /nix/var/nix/profiles/default/bin || echo "Directory not found"
          echo "Contents of /home/runner/.nix-profile/bin:"
          ls -l /home/runner/.nix-profile/bin || echo "Directory not found"

      # Replace the following step with your actual build command.
      # For example, if you have a flake that builds your Pebble app,
      # you might run:
      - name: Build project
        run: |
          # Using nix-shell as a fallback if lix is not directly available
          nix-shell -p lix --run "lix build .#yourTarget" || echo "Build command failed"

      # Optional: Upload the build artifact.
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-result
          path: result